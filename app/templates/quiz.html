<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ quiz.Argomento }} - Quiz</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styleesecuzioneQuiz.css') }}">
</head>
<body>

    <div class="container">
        <h1>{{ quiz.Argomento }}</h1>
        <p><strong>Durata:</strong> {{ quiz.Durata }} minuti</p>
        <p><strong>Tempo rimanente:</strong>
          <span id="timer-minutes">{{ tempo_rimanente // 60 }}</span> minuti e
          <span id="timer-seconds">{{ tempo_rimanente % 60 }}</span> secondi
        </p>

        <form id="quiz-form">
            {% for question in questions %}
            <div class="card">
                <p><strong>{{ loop.index }}. {{ question.Testo_Domanda }}</strong></p>
                <div class="options-container">
                    {% for option in question.Opzioni_Risposte %}
                    <div class="option-container">
                        <input type="radio" id="q{{ question.ID_Domanda }}_{{ loop.index }}"
                               name="q{{ question.ID_Domanda }}" value="{{ option }}">
                        <label for="q{{ question.ID_Domanda }}_{{ loop.index }}">{{ option }}</label>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
            <button type="submit" id="submit-btn" class="btn">Invia Risposte</button>
        </form>
    </div>
    <script>
        // Timer
        const timerMinutesElement = document.getElementById('timer-minutes');
        const timerSecondsElement = document.getElementById('timer-seconds');
        const submitButton = document.getElementById('submit-btn');
        const quizForm = document.getElementById('quiz-form');

        let minutesRemaining = parseInt(timerMinutesElement.textContent);
        let secondsRemaining = parseInt(timerSecondsElement.textContent);

        const timerInterval = setInterval(() => {
            if (minutesRemaining <= 0 && secondsRemaining <= 0) {
                clearInterval(timerInterval);
                timerMinutesElement.textContent = "0";
                timerSecondsElement.textContent = "0";
                timerMinutesElement.parentElement.innerHTML = "Tempo scaduto!";
                submitButton.disabled = true; // Disabilita il pulsante
                const inputs = quizForm.querySelectorAll('input');
                inputs.forEach(input => input.disabled = true); // Disabilita tutte le opzioni
            } else {
                if (secondsRemaining === 0) {
                    minutesRemaining -= 1;
                    secondsRemaining = 59;
                } else {
                    secondsRemaining -= 1;
                }

                // Aggiorna il timer nel DOM
                timerMinutesElement.textContent = minutesRemaining;
                timerSecondsElement.textContent = secondsRemaining.toString().padStart(2, '0');
            }
        }, 1000);

        // Invio delle risposte
        quizForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            // Raccolta risposte
            const formData = new FormData(event.target);
            const risposte = {};
            formData.forEach((value, key) => {
                risposte[key] = value;
            });

            // Aggiungi il codice fiscale dello studente
            risposte["CF_Studente"] = "PRSGST03M19F839F";

            // Invio delle risposte al backend
            const response = await fetch('/quiz/valuta', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(risposte)
            });

            const result = await response.json();
            alert(result.message);
        });
    </script>
</body>
</html>
